<template>
  <v-container>
    <v-row>
      <v-col>
        <v-toolbar color="transparent" flat>
          <v-toolbar-title>Vulnerabilities</v-toolbar-title>
          <v-spacer></v-spacer>
          <v-btn
            color="primary"
            @click="
              () => {
                vulnerability = new Vulnerability();
                vulnerability.id = undefined;
              }
            "
          >
            Create Vulnerability
          </v-btn>
        </v-toolbar>
      </v-col>
    </v-row>

    <v-row>
      <v-col>
        <v-data-table
          :headers="headers"
          :items="vulnerabilitys"
          :items-length="count"
          @update:options="getVulnerabilities"
          @click:row="(event, { item }) => (vulnerability = item)"
        >
        <template v-slot:item.severity="{ item }">
          {{ vulnerabilityTypes.find(t => t.value === item.severity)?.title || "-" }}
        </template>
        </v-data-table>
      </v-col>
    </v-row>
  </v-container>

  <v-dialog
    :model-value="vulnerability.id !== null"
    max-width="700px"
    @update:modelValue="
      (val) => {
        if (!val) vulnerability = new Vulnerability();
      }
    "
  >
    <v-card>
      <v-card-title>Details</v-card-title>
      <v-card-text>
        <v-form>
            <v-text-field
            v-model="vulnerability.name"
            label="Name"
            class="mb-4"
            ></v-text-field>

            <v-textarea
            v-model="vulnerability.description"
            label="Description"
            class="mb-4"
            ></v-textarea>

            <v-select
            v-model="vulnerability.severity"
            :items="vulnerabilityTypes"
            label="Severity"
            class="mb-4"
            ></v-select>

            <v-checkbox
            v-model="vulnerability.is_public"
            label="Public ?"
            color="primary"
            class="mb-4"
            ></v-checkbox>
        </v-form>
      </v-card-text>

      <v-card-actions>
        <v-spacer></v-spacer>

        <v-btn color="red" @click="vulnerability = new Vulnerability()">Cancel</v-btn>
        <v-btn
          v-if="vulnerability.id === undefined"
          color="primary"
          variant="flat"
          append-icon="mdi-content-save-check"
          :loading="posting"
          @click="postSave"
        >
          Save
        </v-btn>
        <v-btn
          v-else-if="vulnerability.id"
          color="primary"
          variant="flat"
          append-icon="mdi-content-save-check"
          :loading="posting"
          @click="patchSave"
        >
          Update
        </v-btn>
      </v-card-actions>
    </v-card>
  </v-dialog>
</template>

<script>
import axios from "@/plugins/axios";
import { defineComponent } from "vue";

class Vulnerability {
  id = null;
  name = "";
  description = "";
  severity = "l";
  is_public = false;
}

export default defineComponent({
  data: () => ({
    loading: false,
    posting: false,
    count: 0,
    Vulnerability,
    vulnerabilitys: [],
    vulnerability: new Vulnerability(),
    vulnerabilityTypes: [],
    headers: [
      { title: "Name", value: "name" },
      { title: "Severity", value: "severity" },
    ],
  }),
  mounted() {
    this.getVulnerabilities();
  },
  methods: {
    async getVulnerabilities(options = { page: 1, itemsPerPage: 20 }) {
      this.loading = true;

      try {
        const {data: opts} = await axios.options("/vulnerabilities/vulnerability/")
        this.vulnerabilityTypes = opts.actions.POST.severity.choices.map(c => ({
          title: c.display_name,
          value: c.value,
        }));

        const { data } = await axios.get("/vulnerabilities/vulnerability/", {
          params: {
            page: options.page,
            page_size: options.itemsPerPage,
          },
        });
        this.count = data.count;
        this.vulnerabilitys = data.results;
      } catch (err) {
        console.error(err);
      }
      this.loading = false;
    },
    async postSave() {
      this.posting = true;
      try {
        const { data } = await axios.post(
          `/vulnerabilities/vulnerability/`,
          this.vulnerability
        );
        this.vulnerability = data;
      } catch (err) {
        console.error(err);
      }
      this.posting = false;
    },
    async patchSave() {
      this.posting = true;
      try {
        const { data } = await axios.patch(
          `/vulnerabilities/vulnerability/${this.vulnerability.id}/`,
          this.vulnerability
        );
        this.vulnerability = new Vulnerability();
      } catch (err) {
        console.error(err);
      }
      this.posting = false;
    },
  },
});
</script>
